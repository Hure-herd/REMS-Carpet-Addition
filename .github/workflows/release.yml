name: release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Your release tag"
        required: true
  release:
    types: [published]

jobs:
  # -------------------
  # 1️⃣ 构建所有版本（只执行一次）
  # -------------------
  build:
    runs-on: ubuntu-24.04
    outputs:
      artifacts-path: ${{ steps.set-path.outputs.path }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'microsoft'

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Build all versions
        run: |
          mkdir -p build-artifacts
          for v in 1.19.4 1.20.1 1.20.4 1.20.6 1.21 1.21.1 1.21.2 1.21.4 1.21.5 1.21.8; do
            ./gradlew :versions:$v:build
            cp versions/$v/build/libs/*.jar build-artifacts/$v.jar
          done

      - name: Set artifacts path
        id: set-path
        run: echo "path=build-artifacts" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build-artifacts

  # -------------------
  # 2️⃣ matrix 上传，每个 Job 使用构建好的 jar
  # -------------------
  upload:
    needs: build
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        mc_version: [1.19.4, 1.20.1, 1.20.4, 1.20.6, 1.21, 1.21.1, 1.21.2, 1.21.4, 1.21.5, 1.21.8]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: build-artifacts

      - name: Set jar path
        id: jar
        run: echo "path=build-artifacts/${{ matrix.mc_version }}.jar" >> $GITHUB_OUTPUT

      - name: Upload to Modrinth
        uses: Kira-NT/mc-publish@v3.3
        with:
          modrinth-id: 175yf82Z 
          modrinth-token: ${{ secrets.MODRINTH_API_TOKEN }}
          files: ${{ steps.jar.outputs.path }}
          name: ${{ format('MyMod {0} for MC {1}', github.event.inputs.tag, matrix.mc_version) }}
          version: ${{ format('{0}-mc{1}', github.event.inputs.tag, matrix.mc_version) }}
          version-type: release
          loaders: fabric
          game-versions: ${{ matrix.mc_version }}
          dependencies: |-
            carpet(required)
          modrinth-changelog: "Released for Minecraft ${{ matrix.mc_version }} (GitHub Actions run ${{ github.run_id }})"
          retry-attempts: 3
          retry-delay: 10000

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          files: ${{ steps.jar.outputs.path }}
